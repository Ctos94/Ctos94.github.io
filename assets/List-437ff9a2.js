import{_ as e,z as t,A as a,r as i,o as l,e as s,w as o,c as n,F as d,b as r,x as c,h as u,a as h,s as g,B as p,C as m,g as k,D as y,y as f,E as b}from"./index-73ede130.js";/* empty css                  *//* empty css                  */import{P as v}from"./PriceFormat-06674fbd.js";import"./common-5afeacdf.js";const C={class:"d-inline-flex align-start header"},w={key:0},T={key:1,class:"text-grey text-caption align-self-center"},q={class:"d-flex justify-end"};const x=e({components:{AutoTagTask:e({components:{Loading:t},data:()=>({task:void 0,interval:null}),computed:{disabled(){return void 0===this.task||this.task&&("RUNNING"===this.task.state||"DISABLED"===this.task.state)}},mounted(){this.state()},methods:{startLoop(){this.interval&&clearInterval(this.interval),this.interval=setInterval((()=>{this.$request.get({url:a.bill.autoTagTask.state}).then((e=>{this.task=e,e&&"RUNNING"!==e.state&&(this.interval&&clearInterval(this.interval),this.$confirm({message:"智能标注任务已完成，是否刷新当前页面?"}).then((()=>{location.reload()})).catch((()=>{this.task=void 0})))}))}),1e4)},state(){this.interval&&clearInterval(this.interval),this.$request.get({url:a.bill.autoTagTask.state}).then((e=>{this.task=e,e&&"RUNNING"===e.state&&this.startLoop()}))},start(){this.$confirm({message:"是否开启智能标注?",beforeClose:(e,t,i)=>{"confirm"===e?(t.confirmButtonLoading=!0,this.$request.post({url:a.bill.autoTagTask.start}).then((()=>{this.state(),i()}))):i()}}).then((()=>{})).catch((()=>{}))},shutdown(e){this.$confirm({message:"是否终止智能标注任务?",beforeClose:(t,i,l)=>{"confirm"===t?(i.confirmButtonLoading=!0,this.$request.post({url:a.bill.autoTagTask.shutdown,data:{id:e}}).then((()=>{i.confirmButtonLoading=!1,this.task=void 0,l()}))):l()}}).then((()=>{this.state()})).catch((()=>{}))},confirm(e){this.$request.post({url:a.bill.autoTagTask.sync,data:{id:e},loading:{target:"#list"}}).then((()=>{location.reload()}))}}},[["render",function(e,t,a,k,y,f){const b=i("Loading"),v=p,C=i("v-icon"),w=i("v-btn"),T=m;return l(),s(T,{effect:"dark",placement:"bottom"},{content:o((()=>[y.task?(l(),n(d,{key:0},["RUNNING"===y.task.state?(l(),n(d,{key:0},[r(c(y.task.id?`正在执行智能标注任务，开始时间：${y.task.createdDate}`:"智能标注任务未能正确关闭")+" ",1),u("span",{class:"text-red pointer auto-tag-btn",onClick:t[0]||(t[0]=e=>f.shutdown(y.task.id))},"终止 ")],64)):"FAIL"===y.task.state?(l(),n(d,{key:1},[r(" 智能标注任务失败 ")],64)):"CONFIRM"===y.task.state?(l(),n(d,{key:2},[r(" 智能标注任务完成 "),u("span",{class:"text-red pointer auto-tag-btn",onClick:t[1]||(t[1]=e=>f.confirm(y.task.id))},"确认标注")],64)):"DISABLED"===y.task.state?(l(),n(d,{key:3},[r(" 暂无待标注数据 ")],64)):(l(),n(d,{key:4},[r("根据交易方和支出项自动标注标签")],64))],64)):(l(),n(d,{key:1},[r("根据交易方和支出项自动标注标签")],64))])),default:o((()=>[h(w,{class:"ml-2",color:"blue-lighten-1",disabled:f.disabled,onClick:f.start},{default:o((()=>[r("智能标注 "),y.task?(l(),n(d,{key:0},["RUNNING"===y.task.state?(l(),s(v,{key:0,style:{"margin-left":"5px"},class:"is-loading"},{default:o((()=>[h(b)])),_:1})):"FAIL"===y.task.state?(l(),s(C,{key:1,class:"ml-2",icon:"mdi-alert-circle"})):g("",!0)],64)):g("",!0)])),_:1},8,["disabled","onClick"])])),_:1})}],["__scopeId","data-v-d33fce2a"]]),PriceFormat:v},data:()=>({tableMaxHeight:0,query:{date:"",tags:[],isOnlyShowAutoTag:!1,keyword:""},pagination:{currentPage:1,pageSize:50,total:0},bills:[],tags:[],editrows:{},loading:!1}),beforeMount(){this.handleTableMaxHeight(),this.$store.commit("update_sider_active","/bill/list")},mounted(){window.onresize=()=>{this.handleTableMaxHeight()},this.$request.get({url:a.bill.list.tags,loading:{target:"#list"}}).then((e=>{this.tags=e}))},methods:{handleTableMaxHeight(){this.tableMaxHeight=document.documentElement.clientHeight-190},requestData(){this.loading=!0,this.$request.get({url:a.bill.list.page,params:{page:this.pagination.currentPage,pageSize:this.pagination.pageSize,date:this.query.date,isOnlyShowAutoTag:this.query.isOnlyShowAutoTag,tags:this.query.tags.join(","),keyword:this.query.keyword}}).then((e=>{this.pagination.total=e.total,this.bills=e.contents})).finally((()=>{this.loading=!1}))},deleteRow(e){this.$confirm({message:"确定要删除吗？"}).then((()=>{this.loading=!0,this.$request.delete({url:a.bill.list.delete,data:{id:e.id}}).then((()=>{this.requestData()}))})).catch((()=>{}))},updateTag(e,t){let i={id:e.id,tag:t,type:e.autoTag?"autoTag":"tag"};this.loading=!0,this.$request.put({url:a.bill.list.updateTag,data:i}).then((()=>{e.autoTag?e.autoTag=t:e.tag=t})).finally((()=>{this.loading=!1}))},async handleCellClick(e,t,i){switch(e){case"edit":t.edit=!0,this.editrows[t.id]=JSON.parse(JSON.stringify(t)),this.bills.splice(i,1,t),this.$nextTick((()=>{this.$refs[`cell-edit-${t.id}`].focus()}));break;case"save":const{valid:e}=await this.$refs.form.validate();if(!e)return;this.loading=!0,this.$request.put({url:a.bill.list.updateDetail,data:{id:t.id,detail:this.editrows[t.id].detail,price:this.editrows[t.id].price}}).then((()=>{t.edit=!1,t.detail=this.editrows[t.id].detail,t.price=this.editrows[t.id].price,this.bills.splice(i,1,t),delete this.editrows[t.id]})).finally((()=>{this.loading=!1}));break;case"cancel":t.edit=!1,this.bills.splice(i,1,t),delete this.editrows[t.id]}}}},[["render",function(e,t,a,p,m,v){const x=b,$=i("v-select"),V=i("v-text-field"),_=i("v-checkbox"),N=i("v-btn"),U=i("AutoTagTask"),I=i("v-sheet"),S=i("PriceFormat"),A=i("v-icon"),D=i("v-chip"),M=i("v-list-item-title"),L=i("v-list-item"),P=i("v-divider"),O=i("v-list"),R=i("v-menu"),j=i("v-btn-link"),z=i("v-pagination"),F=i("v-data-table"),H=i("v-form");return l(),s(I,{id:"list"},{default:o((()=>[u("div",C,[h(x,{modelValue:m.query.date,"onUpdate:modelValue":t[0]||(t[0]=e=>m.query.date=e),class:"date-picker",type:"month",placeholder:"选择月","value-format":"YYYY-MM"},null,8,["modelValue"]),h($,{class:"ml-2",width:"250px",variant:"outlined",density:"compact","hide-details":"",modelValue:m.query.tags,"onUpdate:modelValue":t[1]||(t[1]=e=>m.query.tags=e),clearable:"",multiple:"",label:"标签",items:["EMPTY"].concat(this.tags)},{selection:o((({item:e,index:t})=>[t<1?(l(),n("span",w,c(e.title),1)):g("",!0),1===t?(l(),n("span",T," (+"+c(m.query.tags.length-1)+" others) ",1)):g("",!0)])),_:1},8,["modelValue","items"]),h(V,{class:"ml-2",width:"200px",variant:"outlined",density:"compact","hide-details":"",clearable:"",modelValue:m.query.keyword,"onUpdate:modelValue":t[2]||(t[2]=e=>m.query.keyword=e),label:"交易方|支出项"},null,8,["modelValue"]),h(_,{class:"ml-2",density:"compact",modelValue:m.query.isOnlyShowAutoTag,"onUpdate:modelValue":t[3]||(t[3]=e=>m.query.isOnlyShowAutoTag=e),label:"仅显示智能标注数据"},null,8,["modelValue"]),h(N,{class:"ml-2",color:"blue-lighten-1",onClick:t[4]||(t[4]=()=>{m.pagination.currentPage=1,v.requestData()}),text:"检索"}),h(U)]),h(H,{ref:"form"},{default:o((()=>[h(F,{"show-current-page":"",page:m.pagination.currentPage,"items-per-page":m.pagination.pageSize,headers:[{title:"日期",key:"date",width:180,sortable:!1},{title:"交易方",key:"payee",width:300,sortable:!1},{title:"支出项",key:"detail",sortable:!1},{title:"金额",key:"price",width:180,sortable:!1},{title:"标签",key:"tag",align:"center",width:120,sortable:!1},{title:"操作",key:"actions",width:80,align:"center",sortable:!1}],height:m.tableMaxHeight,items:m.bills,"onUpdate:options":v.requestData,loading:m.loading,"item-key":"id"},{"item.detail":o((({item:t,index:a})=>[t.edit?(l(),s(I,{key:1,class:"d-flex align-center"},{default:o((()=>[h(V,{onKeyup:[k((e=>v.handleCellClick("save",t,a)),["enter"]),k((e=>v.handleCellClick("cancel",t,a)),["esc"])],class:"mr-2",variant:"outlined",density:"compact","hide-details":"",ref:`cell-edit-${t.id}`,rules:[e.$validator.required],modelValue:m.editrows[t.id].detail,"onUpdate:modelValue":e=>m.editrows[t.id].detail=e},null,8,["onKeyup","rules","modelValue","onUpdate:modelValue"]),h(N,{class:"mr-2",color:"blue-lighten-1",onClick:e=>v.handleCellClick("save",t,a),text:"保存"},null,8,["onClick"]),h(N,{color:"red-darken-1",onClick:e=>v.handleCellClick("cancel",t,a),text:"取消"},null,8,["onClick"])])),_:2},1024)):(l(),s(I,{key:0,class:"pointer",onClick:e=>v.handleCellClick("edit",t,a)},{default:o((()=>[r(c(t.detail),1)])),_:2},1032,["onClick"]))])),"item.price":o((({item:t,index:a})=>[t.edit?(l(),s(I,{key:1,class:"d-flex align-center"},{default:o((()=>[h(V,{onKeyup:[k((e=>v.handleCellClick("save",t,a)),["enter"]),k((e=>v.handleCellClick("cancel",t,a)),["esc"])],ref:`${t.id}_price`,class:"mr-2",variant:"outlined",density:"compact","hide-details":"",rules:[e.$validator.required,e.$validator({rule:"price",params:{max:99999999.99}})],modelValue:m.editrows[t.id].price,"onUpdate:modelValue":e=>m.editrows[t.id].price=e},null,8,["onKeyup","rules","modelValue","onUpdate:modelValue"])])),_:2},1024)):(l(),s(I,{key:0,class:"pointer",onClick:e=>v.handleCellClick("edit",t,a)},{default:o((()=>[h(S,{amount:t.price},null,8,["amount"])])),_:2},1032,["onClick"]))])),"item.tag":o((({item:e})=>[h(R,{density:"compact"},{activator:o((({props:t})=>[h(D,y(t,{color:e.autoTag?"orange-lighten-1":"blue-lighten-1",rounded:"sm"}),{default:o((()=>[e.tag||e.autoTag?(l(),n(d,{key:1},[r(c(e.autoTag?e.autoTag:e.tag),1)],64)):(l(),s(A,{key:0,icon:"mdi-plus"}))])),_:2},1040,["color"])])),default:o((()=>[h(O,{class:"pa-0",density:"compact"},{default:o((()=>[(l(!0),n(d,null,f(m.tags,(t=>(l(),s(L,{onClick:a=>v.updateTag(e,t),key:t,value:t},{default:o((()=>[h(M,null,{default:o((()=>[r(c(t),1)])),_:2},1024)])),_:2},1032,["onClick","value"])))),128)),h(P),e.tag||e.autoTag?(l(),s(L,{key:0,class:"text-center",onClick:t=>v.updateTag(e),title:"清  除",value:""},null,8,["onClick"])):g("",!0)])),_:2},1024)])),_:2},1024)])),"item.actions":o((({item:e})=>[h(j,{text:"删除",onClick:t=>v.deleteRow(e)},null,8,["onClick"])])),bottom:o((()=>[u("div",q,[h(z,{density:"comfortable",modelValue:m.pagination.currentPage,"onUpdate:modelValue":[t[5]||(t[5]=e=>m.pagination.currentPage=e),v.requestData],length:Math.floor(m.pagination.total/m.pagination.pageSize)+1,"total-visible":7},null,8,["modelValue","length","onUpdate:modelValue"])])])),_:1},8,["page","items-per-page","height","items","onUpdate:options","loading"])])),_:1},512)])),_:1})}],["__scopeId","data-v-692fb1d3"]]);export{x as default};
