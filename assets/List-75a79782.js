import{_ as I,q as R,A as m,r as o,o as i,e as p,w as n,c as u,F as h,a as g,t as f,h as C,b as s,l as T,s as H,u as z,v as G,n as Y,m as j}from"./index-3676d8ee.js";/* empty css                  *//* empty css                 *//* empty css                  */import{P as J}from"./PriceFormat-106b766d.js";import"./common-1a584e15.js";const K={components:{Loading:R},data(){return{task:void 0,interval:null}},computed:{disabled(){return this.task===void 0?!0:this.task&&(this.task.state==="RUNNING"||this.task.state==="DISABLED")}},mounted(){this.state()},methods:{startLoop(){this.interval&&clearInterval(this.interval),this.interval=setInterval(()=>{this.$request.get({url:m.bill.autoTagTask.state}).then(a=>{this.task=a,a&&a.state!=="RUNNING"&&(this.interval&&clearInterval(this.interval),this.$confirm({message:"智能标注任务已完成，是否刷新当前页面?"}).then(()=>{location.reload()}).catch(()=>{this.task=void 0}))})},1e4)},state(){this.interval&&clearInterval(this.interval),this.$request.get({url:m.bill.autoTagTask.state}).then(a=>{this.task=a,a&&a.state==="RUNNING"&&this.startLoop()})},start(){this.$confirm({message:"是否开启智能标注?",beforeClose:(a,e,c)=>{a==="confirm"?(e.confirmButtonLoading=!0,setTimeout(()=>{c()},500)):c()}}).then(()=>{}).catch(()=>{})},shutdown(a){this.$confirm({message:"是否终止智能标注任务?",beforeClose:(e,c,k)=>{e==="confirm"?(c.confirmButtonLoading=!0,this.$request.post({url:m.bill.autoTagTask.shutdown,data:{id:a}}).then(()=>{c.confirmButtonLoading=!1,this.task=void 0,k()})):k()}}).then(()=>{this.state()}).catch(()=>{})},confirm(a){this.$request.post({url:m.bill.autoTagTask.sync,data:{id:a},loading:{target:"#list"}}).then(()=>{location.reload()})}}};function Q(a,e,c,k,l,d){const q=o("Loading"),V=H,v=o("v-icon"),x=o("v-btn"),y=z;return i(),p(y,{effect:"dark",placement:"bottom"},{content:n(()=>[l.task?(i(),u(h,{key:0},[l.task.state==="RUNNING"?(i(),u(h,{key:0},[g(f(l.task.id?`正在执行智能标注任务，开始时间：${l.task.createdDate}`:"智能标注任务未能正确关闭")+" ",1),C("span",{class:"text-red pointer auto-tag-btn",onClick:e[0]||(e[0]=w=>d.shutdown(l.task.id))},"终止 ")],64)):l.task.state==="FAIL"?(i(),u(h,{key:1},[g(" 智能标注任务失败 ")],64)):l.task.state==="CONFIRM"?(i(),u(h,{key:2},[g(" 智能标注任务完成 "),C("span",{class:"text-red pointer auto-tag-btn",onClick:e[1]||(e[1]=w=>d.confirm(l.task.id))},"确认标注")],64)):l.task.state==="DISABLED"?(i(),u(h,{key:3},[g(" 暂无待标注数据 ")],64)):(i(),u(h,{key:4},[g("根据交易方和支出项自动标注标签")],64))],64)):(i(),u(h,{key:1},[g("根据交易方和支出项自动标注标签")],64))]),default:n(()=>[s(x,{class:"ml-2",color:"blue-lighten-1",disabled:d.disabled,onClick:d.start},{default:n(()=>[g("智能标注 "),l.task?(i(),u(h,{key:0},[l.task.state==="RUNNING"?(i(),p(V,{key:0,style:{"margin-left":"5px"},class:"is-loading"},{default:n(()=>[s(q)]),_:1})):l.task.state==="FAIL"?(i(),p(v,{key:1,class:"ml-2",icon:"mdi-alert-circle"})):T("",!0)],64)):T("",!0)]),_:1},8,["disabled","onClick"])]),_:1})}const W=I(K,[["render",Q],["__scopeId","data-v-797ea3d6"]]);const X={components:{AutoTagTask:W,PriceFormat:J},data(){return{tableMaxHeight:0,query:{date:"",tags:[],isOnlyShowAutoTag:!1,keyword:""},pagination:{currentPage:1,pageSize:50,total:0},bills:[],tags:[],editrows:{},loading:!1}},beforeMount(){this.handleTableMaxHeight(),this.$store.commit("update_sider_active","/bill/list")},mounted(){window.onresize=()=>{this.handleTableMaxHeight()},this.$request.get({url:m.bill.list.tags,loading:{target:"#list"}}).then(a=>{this.tags=a})},methods:{handleTableMaxHeight(){this.tableMaxHeight=document.documentElement.clientHeight-190},requestData(){this.loading=!0,this.$request.get({url:m.bill.list.page,params:{page:this.pagination.currentPage,pageSize:this.pagination.pageSize,date:this.query.date,isOnlyShowAutoTag:this.query.isOnlyShowAutoTag,tags:this.query.tags.join(","),keyword:this.query.keyword}}).then(a=>{this.pagination.total=a.total,this.bills=a.contents}).finally(()=>{this.loading=!1})},deleteRow(a){this.$confirm({message:"确定要删除吗？"}).then(()=>{this.loading=!0,this.$request.delete({url:m.bill.list.delete,data:{id:a.id}}).then(()=>{this.requestData()})}).catch(()=>{})},updateTag(a,e){let c={id:a.id,tag:e,type:a.autoTag?"autoTag":"tag"};this.loading=!0,this.$request.put({url:m.bill.list.updateTag,data:c}).then(()=>{a.autoTag?a.autoTag=e:a.tag=e}).finally(()=>{this.loading=!1})},async handleCellClick(a,e,c){switch(a){case"edit":e.edit=!0,this.editrows[e.id]=JSON.parse(JSON.stringify(e)),this.bills.splice(c,1,e),this.$nextTick(()=>{this.$refs[`cell-edit-${e.id}`].focus()});break;case"save":const{valid:k}=await this.$refs.form.validate();if(!k)return;this.loading=!0,this.$request.put({url:m.bill.list.updateDetail,data:{id:e.id,detail:this.editrows[e.id].detail,price:this.editrows[e.id].price}}).then(()=>{e.edit=!1,e.detail=this.editrows[e.id].detail,e.price=this.editrows[e.id].price,this.bills.splice(c,1,e),delete this.editrows[e.id]}).finally(()=>{this.loading=!1});break;case"cancel":e.edit=!1,this.bills.splice(c,1,e),delete this.editrows[e.id];break}}}},Z={class:"d-inline-flex align-start header"},$={key:0},ee={key:1,class:"text-grey text-caption align-self-center"},te={class:"d-flex justify-end"};function le(a,e,c,k,l,d){const q=j,V=o("v-select"),v=o("v-text-field"),x=o("v-checkbox"),y=o("v-btn"),w=o("AutoTagTask"),b=o("v-sheet"),U=o("PriceFormat"),A=o("v-icon"),L=o("v-chip"),S=o("v-list-item-title"),N=o("v-list-item"),P=o("v-divider"),D=o("v-list"),M=o("v-menu"),B=o("v-btn-link"),F=o("v-pagination"),E=o("v-data-table"),O=o("v-form");return i(),p(b,{id:"list"},{default:n(()=>[C("div",Z,[s(q,{modelValue:l.query.date,"onUpdate:modelValue":e[0]||(e[0]=t=>l.query.date=t),class:"date-picker",type:"month",placeholder:"选择月","value-format":"YYYY-MM"},null,8,["modelValue"]),s(V,{class:"ml-2",width:"250px",variant:"outlined",density:"compact","hide-details":"",modelValue:l.query.tags,"onUpdate:modelValue":e[1]||(e[1]=t=>l.query.tags=t),clearable:"",multiple:"",label:"标签",items:["EMPTY"].concat(this.tags)},{selection:n(({item:t,index:r})=>[r<1?(i(),u("span",$,f(t.title),1)):T("",!0),r===1?(i(),u("span",ee," (+"+f(l.query.tags.length-1)+" others) ",1)):T("",!0)]),_:1},8,["modelValue","items"]),s(v,{class:"ml-2",width:"200px",variant:"outlined",density:"compact","hide-details":"",clearable:"",modelValue:l.query.keyword,"onUpdate:modelValue":e[2]||(e[2]=t=>l.query.keyword=t),label:"交易方|支出项"},null,8,["modelValue"]),s(x,{class:"ml-2",density:"compact",modelValue:l.query.isOnlyShowAutoTag,"onUpdate:modelValue":e[3]||(e[3]=t=>l.query.isOnlyShowAutoTag=t),label:"仅显示智能标注数据"},null,8,["modelValue"]),s(y,{class:"ml-2",color:"blue-lighten-1",onClick:e[4]||(e[4]=()=>{l.pagination.currentPage=1,d.requestData()}),text:"检索"}),s(w)]),s(O,{ref:"form"},{default:n(()=>[s(E,{"show-current-page":"",page:l.pagination.currentPage,"items-per-page":l.pagination.pageSize,headers:[{title:"日期",key:"date",width:180,sortable:!1},{title:"交易方",key:"payee",width:300,sortable:!1},{title:"支出项",key:"detail",sortable:!1},{title:"金额",key:"price",width:180,sortable:!1},{title:"标签",key:"tag",align:"center",width:120,sortable:!1},{title:"操作",key:"actions",width:80,align:"center",sortable:!1}],height:l.tableMaxHeight,items:l.bills,"onUpdate:options":d.requestData,loading:l.loading,"item-key":"id"},{"item.detail":n(({item:t,index:r})=>[t.edit?(i(),p(b,{key:1,class:"d-flex align-center"},{default:n(()=>[s(v,{class:"mr-2",variant:"outlined",density:"compact","hide-details":"",ref:`cell-edit-${t.id}`,rules:[a.$validator.required],modelValue:l.editrows[t.id].detail,"onUpdate:modelValue":_=>l.editrows[t.id].detail=_},null,8,["rules","modelValue","onUpdate:modelValue"]),s(y,{class:"mr-2",color:"blue-lighten-1",onClick:_=>d.handleCellClick("save",t,r),text:"保存"},null,8,["onClick"]),s(y,{color:"red-darken-1",onClick:_=>d.handleCellClick("cancel",t,r),text:"取消"},null,8,["onClick"])]),_:2},1024)):(i(),p(b,{key:0,class:"pointer",onClick:_=>d.handleCellClick("edit",t,r)},{default:n(()=>[g(f(t.detail),1)]),_:2},1032,["onClick"]))]),"item.price":n(({item:t,index:r})=>[t.edit?(i(),p(b,{key:1,class:"d-flex align-center"},{default:n(()=>[s(v,{ref:`${t.id}_price`,class:"mr-2",variant:"outlined",density:"compact","hide-details":"",rules:[a.$validator.required,a.$validator({rule:"price",params:{max:9999999999e-2}})],modelValue:l.editrows[t.id].price,"onUpdate:modelValue":_=>l.editrows[t.id].price=_},null,8,["rules","modelValue","onUpdate:modelValue"])]),_:2},1024)):(i(),p(b,{key:0,class:"pointer",onClick:_=>d.handleCellClick("edit",t,r)},{default:n(()=>[s(U,{amount:t.price},null,8,["amount"])]),_:2},1032,["onClick"]))]),"item.tag":n(({item:t})=>[s(M,{density:"compact"},{activator:n(({props:r})=>[s(L,G(r,{color:t.autoTag?"orange-lighten-1":"blue-lighten-1",rounded:"sm"}),{default:n(()=>[!t.tag&&!t.autoTag?(i(),p(A,{key:0,icon:"mdi-plus"})):(i(),u(h,{key:1},[g(f(t.autoTag?t.autoTag:t.tag),1)],64))]),_:2},1040,["color"])]),default:n(()=>[s(D,{class:"pa-0",density:"compact"},{default:n(()=>[(i(!0),u(h,null,Y(l.tags,r=>(i(),p(N,{onClick:_=>d.updateTag(t,r),key:r,value:r},{default:n(()=>[s(S,null,{default:n(()=>[g(f(r),1)]),_:2},1024)]),_:2},1032,["onClick","value"]))),128)),s(P),t.tag||t.autoTag?(i(),p(N,{key:0,class:"text-center",onClick:r=>d.updateTag(t),title:"清  除",value:""},null,8,["onClick"])):T("",!0)]),_:2},1024)]),_:2},1024)]),"item.actions":n(({item:t})=>[s(B,{text:"删除",onClick:r=>d.deleteRow(t)},null,8,["onClick"])]),bottom:n(()=>[C("div",te,[s(F,{density:"comfortable",modelValue:l.pagination.currentPage,"onUpdate:modelValue":[e[5]||(e[5]=t=>l.pagination.currentPage=t),d.requestData],length:Math.floor(l.pagination.total/l.pagination.pageSize)+1,"total-visible":7},null,8,["modelValue","length","onUpdate:modelValue"])])]),_:1},8,["page","items-per-page","height","items","onUpdate:options","loading"])]),_:1},512)]),_:1})}const de=I(X,[["render",le],["__scopeId","data-v-04bb60f4"]]);export{de as default};
